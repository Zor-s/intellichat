<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Chat</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <!-- BOOTSTRAP ICON -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <style>
      /* OSWALD FONT */
      @import url("https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap");
      /* ROBOTO FONT */
      @import url("https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap");
      .oswald {
        font-family: "Oswald", Sans-Serif;
      }
      .roboto {
        font-family: "Roboto", Sans-Serif;
      }
      body {
        background: #151923;
      }
      * {
        /*
            outline: 1px solid red;
            */
      }
      *::-webkit-scrollbar {
        display: none;
      }
      .main {
        overflow: auto;
        height: 86vh;
      }
      #username {
        background: linear-gradient(to right, #ff7e5f, yellow);
        -webkit-background-clip: text;
        color: transparent;
      }
      .user {
        height: 200px;
      }
      .w_user {
        font-size: 4em;
      }
      .w_assist {
        color: gray;
        font-size: 3.5em;
      }
      @media (max-width: 450px) {
        .w_user {
          font-size: 2.5em;
        }
        .w_assist {
          font-size: 2.3em;
        }
      }

      .card-content {
        width: 100%;
        background: rgb(33, 40, 50);
        border-radius: 20px 20px 20px 0px;
        padding: 20px;
        margin-bottom: 50px;
      }

      .text_prompt textarea {
        width: 100%;
        height: 50px;
        background: transparent;
        border: 1px solid gray;
        border-radius: 10px;
        color: white;
        padding: 0 20px 0 20px;
      }
      .space__for__m {
        width: 50%;
      }
      .user_prompt_section {
        background: linear-gradient(180deg, rgba(33, 40, 50), #2b2b2b);
        width: 50%;
        padding: 20px;
        border-radius: 20px 20px 0px 20px;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="container d-grid align-items-centet vh-80">
        <div class="main d-grid">
          <!--  Welcoming User-->
          <div class="d-grid justify-content-start user mt-5">
            <!-- <hr style="border: none; height: 10px" /> -->
            <h1 class="text-light fw-bold oswald w_user">
              Welcome! <span id="username"><%= username %></span>
            </h1>
            <h1 class="fw-bold roboto w_assist">
              How Can We Assist You Today?
            </h1>
            <!-- <hr style="border: none; height: 30px" /> -->
            <p class="text-light roboto">
              IntelliChat can provide round-the-clock service, ensuring that
              users can get assistance or information at any time without the
              need for human staff to be always available.
            </p>

            <hr style="border: none; height: 30px" />
            <div id="chatArea">
              <!-- User Prompt -->
              <!-- <div class="d-flex justify-content-end mb-3">
                <div class="space__for__m"></div>
                <div class="user_prompt_section">
                  <p class="text-light roboto">Example user prompt</p>
                </div>
              </div> -->
              <!--  response-->
              <!-- <div class="card-content mb-3">
                <p id="chatResponse" class="text-light roboto">
                  Example section of response.
                </p>
              </div> -->
            </div>
            <!-- <hr style="border: none; height: 1000px" /> -->
          </div>
        </div>

        <form id="chatForm" class="text_prompt d-flex align-items-center">
          <textarea
            id="userMessage"
            type="text"
            name="user_prompt"
            placeholder="Enter a text!"
            rows="4"
          ></textarea>
          <button class="btn btn-outline-secondary mx-3">
            <i class="bi bi-send" style="font-size: 1.5em"></i>
          </button>
        </form>
      </div>
    </div>

    <script>
      const chatContainer = document.getElementById("chatArea");
      const messageForm = document.getElementById("chatForm");
      const messageInput = document.getElementById("userMessage");

      messageForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const message = messageInput.value;

        if (message.trim() !== "") {
          const chatBubble = document.createElement("div");
          chatBubble.classList.add("d-flex", "justify-content-end", "mb-3");

          const spaceForM = document.createElement("div");
          spaceForM.classList.add("space__for__m");
          chatBubble.appendChild(spaceForM);

          const promptSection = document.createElement("div");
          promptSection.classList.add("user_prompt_section");
          chatBubble.appendChild(promptSection);

          const messageText = document.createElement("p");
          messageText.classList.add("text-light", "roboto");
          messageText.textContent = message;
          promptSection.appendChild(messageText);

          chatContainer.appendChild(chatBubble);
          messageInput.value = "";
        }

        function createChatBubble(response) {
          const chatBubbleElement = document.createElement("div");
          chatBubbleElement.classList.add("card-content", "mb-3");

          const chatBubbleText = document.createElement("p");
          chatBubbleText.id = "chatResponse";
          chatBubbleText.classList.add("text-light", "roboto");
          chatBubbleText.innerHTML = response;

          chatBubbleElement.appendChild(chatBubbleText);

          chatContainer.appendChild(chatBubbleElement);
        }

        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ message }),
        });

        const data = await response.json();

        function formatText(text) {
          // Replace asterisks with bold tags
          text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

          // Replace single asterisks with bullets (assuming you want an unordered list)
          text = text.replace(/\*(.*)/g, "<li>$1</li>");

          // Replace ## with h1 bold
          text = text.replace(/^## (.*)/gm, "<h1><strong>$1</strong></h1>");

          // Replace ``` with code format
          text = text.replace(/^```(.+?)```/gms, "<pre><code>$1</code></pre>");

          return text;
        }

        const formattedText = formatText(data.response);

        createChatBubble(formattedText);

        // document.getElementById("chatResponse").innerHTML = formattedText;
      });

      async function sendInitialMessage() {
        let userName = "<%= escape(username) %>";
        const initialMessage = "Hi! you are a useful ai assistant that will help the user accomplish his/her tasks. Greet the user, his/her name is \""+userName+"\""; // Customize this message as needed
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ message: initialMessage }),
        });

        const data = await response.json();

        function formatText(text) {
          text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
          text = text.replace(/\*(.*)/g, "<li>$1</li>");
          text = text.replace(/^## (.*)/gm, "<h1><strong>$1</strong></h1>");
          text = text.replace(/^```(.+?)```/gms, "<pre><code>$1</code></pre>");
          return text;
        }

        const formattedText = formatText(data.response);

        createChatBubble(formattedText);
      }

      function createChatBubble(response) {
        const chatBubbleElement = document.createElement("div");
        chatBubbleElement.classList.add("card-content", "mb-3");

        const chatBubbleText = document.createElement("p");
        chatBubbleText.id = "chatResponse";
        chatBubbleText.classList.add("text-light", "roboto");
        chatBubbleText.innerHTML = response;

        chatBubbleElement.appendChild(chatBubbleText);

        chatContainer.appendChild(chatBubbleElement);
      }
      window.onload = sendInitialMessage;
    </script>
  </body>
</html>
